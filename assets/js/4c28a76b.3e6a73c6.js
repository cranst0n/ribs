"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[4174],{5413(e,n,t){t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>p});const s=JSON.parse('{"id":"json/streaming","title":"Streaming","description":"Ribs JSON also comes with an AsyncParser that supports emitting JSON elements","source":"@site/docs/json/streaming.mdx","sourceDirName":"json","slug":"/json/streaming","permalink":"/ribs/docs/json/streaming","draft":false,"unlisted":false,"editUrl":"https://github.com/cranst0n/ribs/edit/main/website/docs/json/streaming.mdx","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Encoding and Decoding","permalink":"/ribs/docs/json/encoding-and-decoding"},"next":{"title":"BitVector","permalink":"/ribs/docs/binary/bit-vector"}}');var r=t(4848),i=t(8453),a=t(2045);const o="// ignore_for_file: unused_local_variable\n\nimport 'dart:io';\n\nimport 'package:ribs_core/ribs_core.dart';\nimport 'package:ribs_json/ribs_json.dart';\n\n// streaming-1\n\nfinal class Event {\n  final String id;\n  final String type;\n  final Repo repo;\n\n  const Event(this.id, this.type, this.repo);\n\n  static final codec = Codec.product3(\n    'id'.as(Codec.string),\n    'type'.as(Codec.string),\n    'repo'.as(Repo.codec),\n    Event.new,\n    (evt) => (evt.id, evt.type, evt.repo),\n  );\n}\n\nfinal class Repo {\n  final int id;\n  final String name;\n\n  const Repo(this.id, this.name);\n\n  static final codec = Codec.product2(\n    'id'.as(Codec.integer),\n    'name'.as(Codec.string),\n    Repo.new,\n    (repo) => (repo.id, repo.name),\n  );\n}\n\n// streaming-1\n\n// streaming-2\n\n// Original stream of bytes\nfinal Stream<List<int>> byteStream = File('path/to/big-array-file.json').openRead();\n\n// Use JsonTransformer to transform the bytes into individual JSON events\nfinal Stream<Json> jsonStream = byteStream.transform(\n  JsonTransformer.bytes(AsyncParserMode.unwrapArray),\n);\n\n// Decode each Json stream element into an event, accounting for failure\nfinal Stream<Either<DecodingFailure, Event>> decodeStream = jsonStream.map(\n  (json) => Event.codec.decode(json),\n);\n\n// One step further...drop any decoding errors\nfinal Stream<Event> eventStream = decodeStream.expand(\n  (element) => element.fold(\n    (err) => <Event>[],\n    (event) => [event],\n  ),\n);\n\n// streaming-2\n\nFuture<void> snippet3() async {\n  // streaming-3\n\n  final Socket sock = await Socket.connect('192.168.0.100', 12345);\n\n  final Stream<Json> jsonStream = sock\n      .map((event) => event.toList())\n      .transform(JsonTransformer.bytes(AsyncParserMode.valueStream));\n\n  // streaming-3\n}\n",l={sidebar_position:4},d="Streaming",c={},p=[{value:"Unwrap Array",id:"unwrap-array",level:2},{value:"Value Stream",id:"value-stream",level:2},{value:"Single Value",id:"single-value",level:2}];function m(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"streaming",children:"Streaming"})}),"\n",(0,r.jsxs)(n.p,{children:["Ribs JSON also comes with an ",(0,r.jsx)(n.code,{children:"AsyncParser"})," that supports emitting JSON elements\nas they arrive in situations like reading bytes from a file or a streaming HTTP\nresponse."]}),"\n",(0,r.jsx)(n.h2,{id:"unwrap-array",children:"Unwrap Array"}),"\n",(0,r.jsxs)(n.p,{children:["The first mode of streaming Ribs supports is ",(0,r.jsx)(n.code,{children:"unwrapArray"}),", which expects the\nstreamed JSON to consist of a top level JSON array. The parser will then emit\nevents as each child element is completely received."]}),"\n",(0,r.jsx)(n.p,{children:"To illustrate, let's start with a basic setup with a couple domain models and\nJSON codecs defined for each:"}),"\n",(0,r.jsx)(a.z,{language:"dart",title:"Models",snippet:o,section:"streaming-1"}),"\n",(0,r.jsx)(n.p,{children:"Now consider that the incoming JSON, (whether it be from a file, a socket or\nan HTTP response), will take on the following structure:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'[\n    {\n        "id": "2489651045",\n        "type": "CreateEvent",\n        "repo": {\n            "id": 28688495,\n            "name": "petroav/6.828",\n            "url": "https://api.github.com/repos/petroav/6.828"\n        }\n    },\n    {\n        "id": "2489651051",\n        "type": "PushEvent",\n        "repo": {\n            "id": 28671719,\n            "name": "rspt/rspt-theme",\n            "url": "https://api.github.com/repos/rspt/rspt-theme"\n        }\n    },\n    //\n    //     Tens, hundreds, thousands of more events....\n    //\n    {\n        "id": "2489651591",\n        "type": "WatchEvent",\n        "repo": {\n            "id": 21289110,\n            "name": "vinta/awesome-python",\n            "url": "https://api.github.com/repos/vinta/awesome-python"\n        }\n    }\n]\n'})}),"\n",(0,r.jsxs)(n.p,{children:["We can emit each of these individual ",(0,r.jsx)(n.code,{children:"Event"}),"s using the ",(0,r.jsx)(n.code,{children:"JsonTransformer"}),"\nin the Ribs Json library. Here's a simple example of how it's used:"]}),"\n",(0,r.jsx)(a.z,{language:"dart",title:"Unwrap Array Transformer",snippet:o,section:"streaming-2"}),"\n",(0,r.jsx)(n.h2,{id:"value-stream",children:"Value Stream"}),"\n",(0,r.jsxs)(n.p,{children:["In the case the stream contains multiple top-level JSON elements, you'll want\nto use ",(0,r.jsx)(n.code,{children:"AsyncParserMode.valueStream"})," when creating your ",(0,r.jsx)(n.code,{children:"JsonTransformer"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"Consider the incoming JSON will look something like this:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'["Name", "Session", "Score", "Completed"]\n{"name": "Gilbert", "wins": [["straight", "7\u2663"], ["one pair", "10\u2665"]]}\n["Gilbert", "2013", 24, true]\n//\n//    tens, hundreds, thousands of other JSON elements...\n//\n{"name": "Deloise", "wins": [["three of a kind", "5\u2663"]]}\n["Deloise", "2012A", 19, true]\n'})}),"\n",(0,r.jsx)(n.p,{children:"We'll creating our transformer in exactly the same way, but change the mode\nthe parser will operate as:"}),"\n",(0,r.jsx)(a.z,{language:"dart",title:"Value Stream Transformer",snippet:o,section:"streaming-3"}),"\n",(0,r.jsx)(n.h2,{id:"single-value",children:"Single Value"}),"\n",(0,r.jsxs)(n.p,{children:["The last mode available expects a single top level JSON element and won't emit\nthe JSON event until it's entirely received. This effectively turns the\n",(0,r.jsx)(n.code,{children:"JsonTransformer"})," into a standard synchronous parser but could still be useful\nin some situations."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(m,{...e})}):m(e)}},2045(e,n,t){t.d(n,{z:()=>a});t(6540);var s=t(3457),r=t(4848);function i(e,n,t){if(null!=n){let t=`// ${n}`,r=e.indexOf(t);if(console.log(r),r>=0){for(;"\n"!=e[r];)r+=1;r+=1}let i=e.indexOf(t,r+1);if(0<=r){var s=(e=e.substring(r,i>=0?i:void 0).trimEnd()).split("\n");if(s.length>0){for(;0==s[0].length;)s.shift();let e=s[0].search(/\S|$/);return s.map(n=>"\n"==n?n:n.substring(e)).join("\n")}return e}return"// Oops! Snippet not found!"}return e}const a=({snippet:e,title:n,section:t,metastring:a})=>null==n||""==n?(0,r.jsx)(s.A,{metastring:a,children:i(e,t)}):(0,r.jsxs)("div",{className:"snippet",children:[(0,r.jsxs)("div",{className:"snippet__title_bar",children:[(0,r.jsxs)("div",{className:"snippet__dots",children:[(0,r.jsx)("div",{className:"snippet__dot"}),(0,r.jsx)("div",{className:"snippet__dot"}),(0,r.jsx)("div",{className:"snippet__dot"})]}),(0,r.jsx)("div",{className:"snippet__title",children:n})]}),(0,r.jsx)(s.A,{metastring:a,children:i(e,t)})]})}}]);